
rule gff_to_bed:
    input:
        "{prefix}/data/annotation/annotation.gff3"
    output:
        "{prefix}/data/annotation/{region_type}/annotation.bed"
    conda:
        "../../envs/global.yaml"
    script:
        "../../scripts/gff2bed.py"



rule remove_duplicate_tss:
    input:
        "{prefix}/data/annotation/{region_type}/annotation.bed"
    output:
        "{prefix}/data/compute_tss/{region_type}/annotation_no_duplicate_tss.bed"
    run:
        import pandas as pd

        colnames = "Chromosome Start End Name Score Strand Gene".split()

        df = pd.read_table(input[0], header=None,
                           names="Chromosome Start End Name Score Strand Gene".split())

        indexes_to_keep = []
        for _, cdf in df.groupby("Chromosome"):
            forward = cdf.loc[cdf.Strand == "+"]
            reverse = cdf.loc[cdf.Strand == "-"]

            new_cdf = pd.concat([forward.Start, reverse.End])
            df_ix = new_cdf.drop_duplicates()
            indexes_to_keep.append(df_ix)


        ix = pd.concat(indexes_to_keep).index

        se = "Start End".split()
        df = df.ix[ix]
        df[se] = df[se].astype(int)

        df.to_csv(output[0], sep="\t", index=False, header=False)
