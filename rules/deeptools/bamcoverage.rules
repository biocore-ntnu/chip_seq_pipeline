bamcoverage_cmd = "bamCoverage --extendReads {params.fragment_size} --centerReads -p {threads} --normalizeUsing RPKM -b {input.bam} -o {output[0]}"


rule bamcoverage:
    input:
        bam = "{prefix}/data/bam/{sample}.sorted.bam",
        index = "{prefix}/data/bam/{sample}.sorted.bam.bai"
    output:
        "{prefix}/data/bamcoverage/{sample}.bw"
    params:
        fragment_size = lambda w: config["fragment_length"] if config["fragment_length"] else frag_sizes[ss[ss.Name == w.sample].Group.iloc[0]]
    threads:
        48
    shell:
        bamcoverage_cmd

rule bamcoverage_merged_group:
    input:
        bam = "{prefix}/data/bamcompare/{group}_{chip}.sorted.bam",
        index = "{prefix}/data/bamcompare/{group}_{chip}.sorted.bam.bai"
    output:
        "{prefix}/data/bamcoverage/merged_{group}_{chip}.bw"
    params:
        fragment_size = lambda w: config["fragment_length"] if config["fragment_length"] else frag_sizes[w.group]
    threads:
        48
    shell:
        bamcoverage_cmd
